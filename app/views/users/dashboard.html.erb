<div class="dashboard-page">
  <div class="grid-container">

    <div class="grid-left m-4" id="grid-left-dashboard">
      <button type="button" class="btn btn-primary btn-lg mb-4" data-bs-toggle="modal" data-bs-target="#addItemModal">
        <i class="fa-solid fa-plus me-2"></i> Add New Game
        </button>

        <% if flash[:alert] %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= flash[:alert] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>
      <% if flash[:notice] %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= flash[:notice] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <h2 class="text-center">MY GAMES</h2>
      <div class="cards-section">
        <% @items.each do |item| %>
          <div class="card card-clickable"
                role="button"
                data-bs-toggle="modal"
                data-bs-target="#editItemModal-<%= item.id %>">
            <div class="card-platform">
              <p>
                <i class="<%= platform_icon(item.platform) %>"></i>
                <%= item.platform %>
              </p>
            </div>
            <% if item.photo.key %>
              <%= cl_image_tag item.photo.key %>
            <% end %>

            <div class="card-title">
              <h2><%= item.title %></h2>
              <%= link_to "Delete",
                item_path(item),
                data: {turbo_method: :delete, turbo_confirm: "Are you sure?"},
                class: "btn btn-danger btn-sm me-2"
              %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="grid-right" id="grid-right-dashboard">
      <div class="m-4">
        <span>USERNAME</span>
        <h2> <%= @user.username %> </h2>
        <hr>
        <span>RECEIVED</span>
        <hr>
          <% @offers_received.each do |offer| %>
          <div class="offer-received">
            <div class="offer-header-dates">
              <h2> <%= offer.item.title.truncate(20) %> </h2>
              <span> <%= offer.start_date %> / <%= offer.end_date %></span>
            </div>
            <div class="offer-comment-buttons">
              <p> <%= offer.comment.truncate(35) %> </p>
              <div class="offer-buttons">
                <i class="fa-solid fa-thumbs-up"></i>
                <%= link_to offer_path(offer), data: {turbo_method: :delete, turbo_confirm: "Are you sure?"} do %>
                  <i class="fa-regular fa-trash-can"></i>
                <% end %>
              </div>
            </div>
          </div>
          <% end %>
        <span>SENT</span>
        <ul>
          <% @offers_made.each do |offer| %>
            <li>
              <%= offer.item.title %>
              <%= offer.start_date %>
              <%= offer.end_date %>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg"> <%# modal-lg для большей ширины, modal-dialog-centered для центрирования по вертикали %>
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addItemModalLabel">Add a new game to your collection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%# Рендерим наш частичный шаблон формы _form.html.erb %>
        <%# 'item: @item || Item.new' передает либо существующий @item (если он пришел с ошибками после неудачной отправки), либо новый пустой Item %>
        <%= render 'items/form', item: @item || Item.new %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <%# Кнопка "Отправить" находится внутри формы, поэтому здесь она не нужна %>
      </div>
    </div>
  </div>
</div>

<% @items.each do |item| %>
<div class="modal fade" id="editItemModal-<%= item.id %>" tabindex="-1" aria-labelledby="editItemModalLabel-<%= item.id %>" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editItemModalLabel-<%= item.id %>">Edit the game: <%= item.title %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <turbo-frame id="edit_item_form_<%= item.id %>" src="<%= edit_item_path(item, format: :turbo_stream) %>">
          <%# Показываем заглушку, пока форма загружается %>
          <p>Загрузка формы...</p>
        </turbo-frame>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<% end %>
